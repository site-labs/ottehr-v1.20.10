name: Deploy Intake App

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      id-token: write
      contents: read
    env:
      AWS_PROFILE: ${{ vars.AWS_PROFILE }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      S3_BUCKET: ${{ vars.S3_BUCKET }}
      CLOUDFRONT_ID: ${{ vars.CLOUDFRONT_ID }}
      ENV: ${{ github.event.inputs.environment }}
      VITE_APP_IS_LOCAL: ${{ vars.VITE_APP_IS_LOCAL }}
      VITE_APP_NAME: ${{ vars.VITE_APP_NAME }}
      VITE_APP_CLIENT_ID: ${{ vars.VITE_APP_CLIENT_ID }}
      VITE_APP_AUTH_URL: ${{ vars.VITE_APP_AUTH_URL }}
      VITE_APP_AUTH0_AUDIENCE: ${{ vars.AUTH0_AUDIENCE }}
      VITE_APP_FHIR_API_URL: ${{ vars.VITE_APP_FHIR_API_URL }}
      VITE_APP_PROJECT_API_URL: ${{ vars.VITE_APP_PROJECT_API_URL }}
      VITE_APP_MIXPANEL_TOKEN: ${{ vars.VITE_APP_MIXPANEL_TOKEN }}
      VITE_APP_GTM_ID: ${{ vars.VITE_APP_GTM_ID }}
      VITE_APP_STRIPE_KEY: ${{ vars.VITE_APP_STRIPE_KEY }}
      VITE_APP_AI_INTERVIEW_BANNER_ENABLED: ${{ vars.VITE_APP_AI_INTERVIEW_BANNER_ENABLED }}
      VITE_APP_ENV: ${{ github.event.inputs.environment }}
      VITE_APP_PROJECT_ID: ${{ vars.VITE_APP_PROJECT_ID }}
    steps:
      - name: Checkout (use branch selected in UI)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (root)
        run: npm ci

      - name: Configure AWS credentials (OIDC or Secrets)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
        env:
          S3_BUCKET: ${{ vars.S3_BUCKET }}
          CLOUDFRONT_ID: ${{ vars.CLOUDFRONT_ID }}
          AWS_PROFILE: ${{ vars.AWS_PROFILE }}
          AWS_REGION: ${{ vars.AWS_REGION }}
          VITE_APP_IS_LOCAL: false
          VITE_APP_NAME: ${{ vars.VITE_APP_NAME }}
          VITE_APP_CLIENT_ID: ${{ vars.VITE_APP_CLIENT_ID }}
          VITE_APP_AUTH_URL: ${{ vars.VITE_APP_AUTH_URL }}
          VITE_APP_AUTH0_AUDIENCE: ${{ vars.AUTH0_AUDIENCE }}
          VITE_APP_FHIR_API_URL: ${{ vars.VITE_APP_FHIR_API_URL }}
          VITE_APP_PROJECT_API_URL: ${{ vars.VITE_APP_PROJECT_API_URL }}
          VITE_APP_MIXPANEL_TOKEN: ${{ vars.VITE_APP_MIXPANEL_TOKEN }}
          VITE_APP_GTM_ID: ${{ vars.VITE_APP_GTM_ID }}
          VITE_APP_STRIPE_KEY: ${{ vars.VITE_APP_STRIPE_KEY }}
          VITE_APP_AI_INTERVIEW_BANNER_ENABLED: ${{ vars.VITE_APP_AI_INTERVIEW_BANNER_ENABLED }}
          VITE_APP_ENV: ${{ github.event.inputs.environment }}
          VITE_APP_PROJECT_ID: ${{ vars.VITE_APP_PROJECT_ID }}

      - name: Create apps/intake env file from secrets
        run: |
          set -e
          ENV=${{ github.event.inputs.environment }}
          mkdir -p apps/intake/env
          # Write a simple key=value .env file consumed by the build scripts
          cat > apps/intake/env/.env.${ENV} <<-EOF
            VITE_APP_IS_LOCAL=${VITE_APP_IS_LOCAL}
            VITE_APP_NAME=${VITE_APP_NAME}
            VITE_APP_CLIENT_ID=${VITE_APP_CLIENT_ID}
            VITE_APP_AUTH_URL=${VITE_APP_AUTH_URL}
            VITE_APP_AUTH0_AUDIENCE=${VITE_APP_AUTH0_AUDIENCE}
            VITE_APP_FHIR_API_URL=${VITE_APP_FHIR_API_URL}
            VITE_APP_PROJECT_API_URL=${VITE_APP_PROJECT_API_URL}
            VITE_APP_MIXPANEL_TOKEN=${VITE_APP_MIXPANEL_TOKEN}
            VITE_APP_GTM_ID=${VITE_APP_GTM_ID}
            VITE_APP_STRIPE_KEY=${VITE_APP_STRIPE_KEY}
            VITE_APP_AI_INTERVIEW_BANNER_ENABLED=${VITE_APP_AI_INTERVIEW_BANNER_ENABLED}
            VITE_APP_ENV=${VITE_APP_ENV}
            VITE_APP_PROJECT_ID=${VITE_APP_PROJECT_ID}
          EOF


      - name: Run intake deploy script
        working-directory: apps/intake
        run: |
          npm run ci-deploy

      - name: Remove sensitive env file
        run: rm -f apps/intake/env/.env.${{ github.event.inputs.environment }}
